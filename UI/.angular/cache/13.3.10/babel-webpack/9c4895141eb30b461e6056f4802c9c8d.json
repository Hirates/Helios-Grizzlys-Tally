{"ast":null,"code":"const {\n  webm,\n  mp4\n} = require(\"./media.js\"); // Detect iOS browsers < version 10\n\n\nconst oldIOS = () => typeof navigator !== \"undefined\" && parseFloat((\"\" + (/CPU.*OS ([0-9_]{3,4})[0-9_]{0,1}|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent) || [0, \"\"])[1]).replace(\"undefined\", \"3_2\").replace(\"_\", \".\").replace(\"_\", \"\")) < 10 && !window.MSStream; // Detect native Wake Lock API support\n\n\nconst nativeWakeLock = () => \"wakeLock\" in navigator;\n\nclass NoSleep {\n  constructor() {\n    this.enabled = false;\n\n    if (nativeWakeLock()) {\n      this._wakeLock = null;\n\n      const handleVisibilityChange = () => {\n        if (this._wakeLock !== null && document.visibilityState === \"visible\") {\n          this.enable();\n        }\n      };\n\n      document.addEventListener(\"visibilitychange\", handleVisibilityChange);\n      document.addEventListener(\"fullscreenchange\", handleVisibilityChange);\n    } else if (oldIOS()) {\n      this.noSleepTimer = null;\n    } else {\n      // Set up no sleep video element\n      this.noSleepVideo = document.createElement(\"video\");\n      this.noSleepVideo.setAttribute(\"title\", \"No Sleep\");\n      this.noSleepVideo.setAttribute(\"playsinline\", \"\");\n\n      this._addSourceToVideo(this.noSleepVideo, \"webm\", webm);\n\n      this._addSourceToVideo(this.noSleepVideo, \"mp4\", mp4);\n\n      this.noSleepVideo.addEventListener(\"loadedmetadata\", () => {\n        if (this.noSleepVideo.duration <= 1) {\n          // webm source\n          this.noSleepVideo.setAttribute(\"loop\", \"\");\n        } else {\n          // mp4 source\n          this.noSleepVideo.addEventListener(\"timeupdate\", () => {\n            if (this.noSleepVideo.currentTime > 0.5) {\n              this.noSleepVideo.currentTime = Math.random();\n            }\n          });\n        }\n      });\n    }\n  }\n\n  _addSourceToVideo(element, type, dataURI) {\n    var source = document.createElement(\"source\");\n    source.src = dataURI;\n    source.type = `video/${type}`;\n    element.appendChild(source);\n  }\n\n  get isEnabled() {\n    return this.enabled;\n  }\n\n  enable() {\n    if (nativeWakeLock()) {\n      return navigator.wakeLock.request(\"screen\").then(wakeLock => {\n        this._wakeLock = wakeLock;\n        this.enabled = true;\n        console.log(\"Wake Lock active.\");\n\n        this._wakeLock.addEventListener(\"release\", () => {\n          // ToDo: Potentially emit an event for the page to observe since\n          // Wake Lock releases happen when page visibility changes.\n          // (https://web.dev/wakelock/#wake-lock-lifecycle)\n          console.log(\"Wake Lock released.\");\n        });\n      }).catch(err => {\n        this.enabled = false;\n        console.error(`${err.name}, ${err.message}`);\n        throw err;\n      });\n    } else if (oldIOS()) {\n      this.disable();\n      console.warn(`\n        NoSleep enabled for older iOS devices. This can interrupt\n        active or long-running network requests from completing successfully.\n        See https://github.com/richtr/NoSleep.js/issues/15 for more details.\n      `);\n      this.noSleepTimer = window.setInterval(() => {\n        if (!document.hidden) {\n          window.location.href = window.location.href.split(\"#\")[0];\n          window.setTimeout(window.stop, 0);\n        }\n      }, 15000);\n      this.enabled = true;\n      return Promise.resolve();\n    } else {\n      let playPromise = this.noSleepVideo.play();\n      return playPromise.then(res => {\n        this.enabled = true;\n        return res;\n      }).catch(err => {\n        this.enabled = false;\n        throw err;\n      });\n    }\n  }\n\n  disable() {\n    if (nativeWakeLock()) {\n      if (this._wakeLock) {\n        this._wakeLock.release();\n      }\n\n      this._wakeLock = null;\n    } else if (oldIOS()) {\n      if (this.noSleepTimer) {\n        console.warn(`\n          NoSleep now disabled for older iOS devices.\n        `);\n        window.clearInterval(this.noSleepTimer);\n        this.noSleepTimer = null;\n      }\n    } else {\n      this.noSleepVideo.pause();\n    }\n\n    this.enabled = false;\n  }\n\n}\n\nmodule.exports = NoSleep;","map":null,"metadata":{},"sourceType":"script"}